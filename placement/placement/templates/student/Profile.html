{% extends 'base.html' %}
{% load static %}

{% block title %}Student Profile{% endblock %}

{% block extra_css %}
<style>
    #profilePreview {
        width: 150px;
        height: 150px;
        object-fit: cover;
    }
    .profile-picture-container {
        position: relative;
        display: inline-block;
    }
    .camera-btn {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: #0d6efd;
        color: white;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    .no-student-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        width: 100%;
    }
</style>
{% endblock %}

{% block page %}Profile{% endblock %}
{% block Main_title %}Student Profile{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <div class="row">
        <div class="col-12 col-lg-10 mx-auto">
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <div class="d-flex flex-column flex-md-row align-items-center {% if not student %}no-student-content{% endif %}">
                        <div class="text-center mb-4 mb-md-0 {% if not student %}me-md-0{% else %}me-md-4{% endif %}">
                            {% if student and student.profile_picture %}
                                <img src="{{ student.profile_picture.url }}" alt="Profile Picture" class="rounded-circle shadow-sm" width="150" height="150">
                            {% else %}
                                <img src="https://ui-avatars.com/api/?name={% if student %}{{ student.name|urlencode }}{% else %}{{request.user}}{% endif %}&background=0D8ABC&color=fff&rounded=true&size=150" alt="Avatar" class="rounded-circle shadow-sm" width="150" height="150">
                            {% endif %}
                            <button class="btn btn-outline-primary mt-3 w-100" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                                <i class="bi {% if student %}bi-pencil-fill{% else %}bi-plus-circle-fill{% endif %} me-2"></i>
                                {% if student %}Edit{% else %}Add{% endif %} Profile
                            </button>
                        </div>

                        {% if student %}
                        <div class="flex-grow-1">
                            <h2 class="mb-3">{{ student.name }}</h2>
                            <div class="mb-2"><strong>Email:</strong> {{ student.email }}</div>
                            <div class="mb-2"><strong>Phone:</strong> {{ student.phone }}</div>
                            <div class="mb-2"><strong>Address:</strong> {{ student.address }}</div>
                            <div class="mb-2"><strong>Date of Birth:</strong> {{ student.date_of_birth }}</div>
                            <div class="mb-2"><strong>Gender:</strong> {{ student.gender }}</div>
                            <div class="mb-2"><strong>Blood Group:</strong> {{ student.blood_group }}</div>
                            <div class="mb-2"><strong>Course:</strong> {{ student.course }}</div>
                            <div class="mb-2"><strong>Branch:</strong> {{ student.branch }}</div>
                            <div class="mb-2"><strong>Year:</strong> {{ student.year }}</div>
                            <div class="mb-2"><strong>Semester:</strong> {{ student.sem }}</div>
                            <div class="mb-2"><strong>Roll No:</strong> {{ student.roll_no }}</div>
                            <div class="mb-2"><strong>Reg No:</strong> {{ student.reg_no }}</div>
                            <div class="mb-2"><strong>CGPA:</strong> {{ student.cgpa }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editProfileModalLabel">{% if student %}Edit{% else %}Add{% endif %} Profile</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center mb-4 mb-md-0">
                            <div class="profile-picture-container">
                                <img id="profilePreview" 
                                     src="{% if student and student.profile_picture %}{{ student.profile_picture.url }}{% else %}https://ui-avatars.com/api/?name={% if student %}{{ student.name|urlencode }}{% else %}{{request.user}}{% endif %}&background=0D8ABC&color=fff&rounded=true&size=150{% endif %}" 
                                     class="rounded-circle shadow-sm"
                                     width="150"
                                     height="150">
                                <label for="id_profile_picture" class="camera-btn">
                                    <i class="bi bi-camera-fill"></i>
                                </label>
                                <input type="file" name="profile_picture" id="id_profile_picture" class="d-none" accept="image/*">
                            </div>
                            <div class="mt-2 small text-muted">JPG, PNG max 2MB</div>
                        </div>

                        <div class="col-md-8">
                            <div class="row">
                                {% if student %}
                                    <input type="hidden" name="hide" value="hide">
                                {% endif %}
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Full Name</label>
                                    <input type="text" name="name" value="{{ student.name|default:'' }}" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" name="email" value="{{ student.email|default:'' }}" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" name="phone" value="{{ student.phone|default:'' }}" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Address</label>
                                    <input type="text" name="address" value="{{ student.address|default:'' }}" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Date of Birth</label>
                                    <input type="date" name="date_of_birth" value="{{ student.date_of_birth|date:'Y-m-d' }}" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Gender</label>
                                    <input type="text" name="gender" value="{{ student.gender|default:'' }}" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Blood Group</label>
                                    <input type="text" name="blood_group" value="{{ student.blood_group|default:'' }}" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Course</label>
                                    <input type="text" name="course" value="{{ student.course|default:'' }}" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Branch</label>
                                    <input type="text" name="branch" value="{{ student.branch|default:'' }}" class="form-control" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Year</label>
                                    <input type="text" name="year" value="{{ student.year|default:'' }}" class="form-control" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Semester</label>
                                    <input type="text" name="sem" value="{{ student.sem|default:'' }}" class="form-control" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Roll No</label>
                                    <input type="text" name="roll_no" value="{{ student.roll_no|default:'' }}" class="form-control" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Reg No</label>
                                    <input type="text" name="reg_no" value="{{ student.reg_no|default:'' }}" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">CGPA</label>
                                    <input type="number" step="0.01" name="cgpa" value="{{ student.cgpa|default:'' }}" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const profilePictureInput = document.getElementById('id_profile_picture');
    const profilePreview = document.getElementById('profilePreview');
    const editModal = document.getElementById('editProfileModal');

  const defaultImageUrl = "{% if student and student.profile_picture %}{{ student.profile_picture.url }}{% else %}''{% endif %}";
    if (profilePictureInput && profilePreview) {
        profilePictureInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type.match('image.*')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    profilePreview.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                profilePreview.src = defaultImageUrl;
            }
        });
    }

    if (editModal) {
        editModal.addEventListener('hidden.bs.modal', function() {
            if (profilePreview) {
                profilePreview.src = defaultImageUrl;
            }
            const form = this.querySelector('form');
            if (form) {
                form.reset();
            }
        });
    }
});
</script>
{% endblock %}
